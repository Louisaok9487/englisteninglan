<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英語學習應用程式</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better aesthetics and responsiveness */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5; /* Light grey background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better content flow */
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .app-container {
            background-color: #ffffff;
            border-radius: 16px; /* More rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Softer shadow */
            width: 100%;
            max-width: 800px; /* Max width for desktop */
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .tab-button {
            padding: 1rem 1.5rem;
            font-weight: 600;
            color: #4b5563; /* Grey text */
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            color: #1d4ed8; /* Blue text */
            border-color: #1d4ed8; /* Blue underline */
        }
        .content-section {
            padding: 1.5rem;
            display: none; /* Hidden by default */
        }
        .content-section.active {
            display: block; /* Shown when active */
        }

        /* Styling for buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px; /* Pill shape */
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none; /* Remove default border */
            cursor: pointer;
        }
        .btn-primary {
            background-color: #3b82f6; /* Blue */
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Darker blue */
            transform: translateY(-2px); /* Lift effect */
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .btn-secondary {
            background-color: #e5e7eb; /* Light grey */
            color: #374151; /* Dark grey text */
        }
        .btn-secondary:hover {
            background-color: #d1d5db; /* Darker light grey */
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .btn-danger {
            background-color: #ef4444; /* Red */
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* Darker red */
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }

        /* Styling for disabled buttons */
        .btn:disabled {
            opacity: 0.5; /* Make it visibly greyed out */
            cursor: not-allowed; /* Change cursor to indicate it's not clickable */
            box-shadow: none; /* Remove shadow when disabled */
            transform: none; /* Remove lift effect when disabled */
        }

        /* Input styling */
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }

        /* Message Box Styling */
        .message-box {
            background-color: #fefcbf; /* Light yellow */
            border: 1px solid #fcd34d; /* Yellow border */
            color: #92400e; /* Dark brown text */
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none; /* Hidden by default */
        }
        .message-box.show {
            display: block;
        }

        /* Specific styles for conversation display */
        .conversation-line {
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        .conversation-line:last-child {
            border-bottom: none;
        }
        .option-button {
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            background-color: #f9fafb;
            transition: all 0.2s ease;
        }
        .option-button:hover:not(:disabled) {
            background-color: #e5e7eb;
            border-color: #9ca3af;
        }
        .option-button.selected {
            border-color: #3b82f6;
            background-color: #dbeafe;
            font-weight: 600;
        }
        .option-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="antialiased">
    <div class="app-container">
        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-200">
            <button id="listeningTabBtn" class="tab-button active flex-1 text-center">聽力練習 🎧</button>
            <!-- Speaking tab removed -->
        </div>

        <!-- Listening Practice Tab Content -->
        <div id="listeningContent" class="content-section active">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">聽力練習</h2>

            <!-- Accent Selection -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg shadow-sm">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">選擇口音</h3>
                <div class="flex flex-wrap gap-3">
                    <button id="usAccentBtn" class="btn btn-secondary">美式口音 🇺🇸</button>
                    <button id="ukAccentBtn" class="btn btn-primary">英式口音 🇬🇧</button>
                </div>
            </div>

            <!-- Listening Comprehension Quiz -->
            <div class="p-4 bg-green-50 rounded-lg shadow-sm">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">情境對話理解 <span id="scenarioNumberDisplay" class="text-base font-normal text-gray-500 ml-2"></span></h3>
                <p class="text-gray-600 mb-4">仔細聆聽對話，然後回答問題。</p>

                <div id="conversationDisplay" class="bg-white p-4 rounded-lg shadow-inner mb-6 min-h-[120px] flex flex-col justify-center">
                    <!-- Conversation lines will be inserted here -->
                    <p class="text-gray-500 italic">點擊「播放對話」開始。</p>
                </div>

                <div class="flex flex-col sm:flex-row gap-3 mb-4">
                    <button id="playConversationBtn" class="btn btn-primary flex-1">播放對話 ▶️</button>
                    <button id="pauseConversationBtn" class="btn btn-secondary flex-1" disabled>暫停 ⏸️</button>
                    <button id="stopConversationBtn" class="btn btn-danger flex-1" disabled>停止 ⏹️</button>
                    <button id="nextScenarioBtn" class="btn btn-secondary flex-1">下一個隨機情境 ➡️</button>
                </div>

                <p id="scenarioQuestion" class="text-lg font-semibold text-gray-800 mb-4 mt-4 hidden">問題：</p>
                <div id="optionsContainer" class="grid grid-cols-1 gap-3 mb-4">
                    <!-- Options buttons will be inserted here -->
                </div>

                <div class="flex flex-wrap gap-3">
                    <button id="checkAnswerBtn" class="btn btn-primary" disabled>檢查答案 ✅</button>
                    <button id="showTranscriptBtn" class="btn btn-secondary" disabled>顯示中文原文 📖</button>
                </div>
                <p id="quizFeedback" class="text-lg font-semibold mt-4"></p>
                <p id="quizTranscriptDisplay" class="text-gray-700 mt-2 italic hidden whitespace-pre-wrap"></p>
            </div>
        </div>

        <!-- Speaking Practice Tab Content Removed -->

        <!-- Global Message Box -->
        <div id="messageBox" class="message-box"></div>
    </div>

    <script>
        // --- Global Variables and Initial Setup ---
        const appContainer = document.querySelector('.app-container');
        const listeningTabBtn = document.getElementById('listeningTabBtn');
        const listeningContent = document.getElementById('listeningContent');
        const messageBox = document.getElementById('messageBox');

        // Speech Synthesis (TTS)
        const synth = window.speechSynthesis;
        let currentUtterance = null; // To keep track of the current speaking utterance
        let isConversationPlaying = false;
        let isConversationPaused = false;
        let speaker1Voice = null; // Voice for speaker 1
        let speaker2Voice = null; // Voice for speaker 2
        let currentAccent = 'en-GB'; // Default accent for all speech

        // Speech Recognition (STT) - Removed as speaking tab is removed
        let recognition = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordedAudioBlob = null;
        let audioContext = null;
        let sourceNode = null;

        // --- Listening Scenarios for Taiwan Daily Life ---
        const listeningScenarios = [
            {
                topic: "Asking for Direction (問路)",
                conversation: [
                    "Tourist: Excuse me, could you tell me how to get to Taipei 101?",
                    "Local: Of course! Go straight down this road, then turn left at the second traffic light.",
                    "Tourist: Straight, then left at the second light. Got it. Is it far from there?",
                    "Local: Not really. It's about a ten-minute walk. You can't miss it.",
                    "Tourist: Thank you so much for your help!",
                    "Local: You're welcome! Have a good day."
                ],
                chineseTranslation: "遊客：不好意思，請問台北101怎麼走？\n當地人：當然！沿著這條路直走，然後在第二個紅綠燈左轉。\n遊客：直走，第二個紅綠燈左轉。知道了。離那裡遠嗎？\n當地人：不太遠。大約走十分鐘。你不會錯過的。\n遊客：非常感謝您的幫助！\n當地人：不客氣！祝您有美好的一天。",
                question: "根據對話，遊客需要在哪裡轉彎？",
                options: ["第一個紅綠燈", "第二個紅綠燈", "第三個紅綠燈", "在路口右轉"],
                correctAnswerIndex: 1,
                englishTranscript: "Tourist: Excuse me, could you tell me how to get to Taipei 101?\nLocal: Of course! Go straight down this road, then turn left at the second traffic light.\nTourist: Straight, then left at the second light. Got it. Is it far from there?\nLocal: Not really. It's about a ten-minute walk. You can't miss it.\nTourist: Thank you so much for your help!\nLocal: You're welcome! Have a good day."
            },
            {
                topic: "Ordering at a Restaurant (餐廳點餐)",
                conversation: [
                    "Waiter: Welcome! What can I get for you today?",
                    "Customer: Hi! I'd like a large bubble milk tea, half sugar, less ice.",
                    "Waiter: Half sugar, less ice, got it. Anything else?",
                    "Customer: Yes, and one beef noodle soup, please.",
                    "Waiter: Excellent choice! That'll be 250 NTD.",
                    "Customer: Here you go. Thank you!"
                ],
                chineseTranslation: "服務生：歡迎光臨！今天想點什麼？\n顧客：嗨！我想要一杯大杯珍珠奶茶，半糖少冰。\n服務生：半糖少冰，好的。還有別的嗎？\n顧客：是的，再加一份牛肉麵，謝謝。\n服務生：很棒的選擇！總共是新台幣250元。\n顧客：給你。謝謝！",
                question: "顧客點了什麼飲料？",
                options: ["咖啡", "綠茶", "珍珠奶茶", "果汁"],
                correctAnswerIndex: 2,
                englishTranscript: "Waiter: Welcome! What can I get for you today?\nCustomer: Hi! I'd like a large bubble milk tea, half sugar, less ice.\nWaiter: Half sugar, less ice, got it. Anything else?",
            },
            {
                topic: "Airport Check-in (機場報到)",
                conversation: [
                    "Agent: Good morning! Passport and ticket, please.",
                    "Passenger: Good morning. Here you are.",
                    "Agent: Are you checking any bags today?",
                    "Passenger: Yes, just one suitcase.",
                    "Agent: Alright. Your gate is A12, and boarding starts at 9:30 AM.",
                    "Passenger: Thank you!"
                ],
                chineseTranslation: "櫃檯人員：早安！請出示護照和機票。\n乘客：早安。給你。\n櫃檯人員：今天有要託運的行李嗎？\n乘客：是的，只有一個行李箱。\n櫃檯人員：好的。您的登機門是A12，上午9:30開始登機。\n乘客：謝謝！",
                question: "乘客有幾件行李要託運？",
                options: ["沒有", "一件", "兩件", "三件"],
                correctAnswerIndex: 1,
                englishTranscript: "Agent: Good morning! Passport and ticket, please.\nPassenger: Good morning. Here you are.\nAgent: Are you checking any bags today?\nPassenger: Yes, just one suitcase.\nAgent: Alright. Your gate is A12, and boarding starts at 9:30 AM.\nPassenger: Thank you!"
            },
            {
                topic: "Shopping at a Night Market (夜市購物)",
                conversation: [
                    "Vendor: Hello! Can I help you?",
                    "Customer: Hi! How much is this T-shirt?",
                    "Vendor: That one is 350 NTD.",
                    "Customer: Hmm, is there a smaller size available?",
                    "Vendor: Yes, we have small and medium. Which one would you like?",
                    "Customer: I'll take the small, please."
                ],
                chineseTranslation: "攤販：你好！需要幫忙嗎？\n顧客：嗨！這件T恤多少錢？\n攤販：那件是新台幣350元。\n顧客：嗯，有小一點的尺寸嗎？\n攤販：有，我們有小號和中號。你想要哪一個？\n顧客：我拿小號的，謝謝。",
                question: "顧客想知道T恤的什麼資訊？",
                options: ["顏色", "價格", "材質", "品牌"],
                correctAnswerIndex: 1,
                englishTranscript: "Vendor: Hello! Can I help you?\nCustomer: Hi! How much is this T-shirt?\nVendor: That one is 350 NTD.\nCustomer: Hmm, is there a smaller size available?",
            },
            {
                topic: "Taking a Taxi (搭計程車)",
                conversation: [
                    "Passenger: Excuse me, are you free?",
                    "Driver: Yes, where are you going?",
                    "Passenger: To Ximending, please. How much will it be?",
                    "Driver: About 200 to 250 NTD, depending on traffic.",
                    "Passenger: Okay, let's go.",
                    "Driver: Hop in!"
                ],
                chineseTranslation: "乘客：不好意思，你空著嗎？\n司機：是的，你要去哪裡？\n乘客：請到西門町。大概多少錢？\n司機：大約新台幣200到250元，取決於交通狀況。\n乘客：好的，走吧。\n司機：上車！",
                question: "計程車司機預估車資大約是多少？",
                options: ["100-150元", "200-250元", "300-350元", "400元以上"],
                correctAnswerIndex: 1,
                englishTranscript: "Passenger: Excuse me, are you free?\nDriver: Yes, where are you going?\nPassenger: To Ximending, please. How much will it be?\nDriver: About 200 to 250 NTD, depending on traffic.\nPassenger: Okay, let's go.\nDriver: Hop in!"
            },
            {
                topic: "Visiting a Temple (參觀廟宇)",
                conversation: [
                    "Visitor: This temple is beautiful! How old is it?",
                    "Guide: It was built over 300 years ago, during the Qing Dynasty.",
                    "Visitor: Wow, that's amazing. What are these carvings about?",
                    "Guide: They depict stories from ancient Chinese folklore and mythology.",
                    "Visitor: Fascinating! Thank you for the information.",
                    "Guide: My pleasure."
                ],
                chineseTranslation: "遊客：這座廟真漂亮！它有多久歷史了？\n導遊：它建於300多年前，清朝時期。\n遊客：哇，太棒了。這些雕刻是關於什麼的？\n導遊：它們描繪了中國古代民間傳說和神話故事。\n遊客：真引人入勝！謝謝你的資訊。\n導遊：不客氣。",
                question: "這座廟宇大約建於多久以前？",
                options: ["100多年前", "200多年前", "300多年前", "400多年前"],
                correctAnswerIndex: 2,
                englishTranscript: "Visitor: This temple is beautiful! How old is it?\nGuide: It was built over 300 years ago, during the Qing Dynasty.\nVisitor: Wow, that's amazing. What are these carvings about?\nGuide: They depict stories from ancient Chinese folklore and mythology.\nVisitor: Fascinating! Thank you for the information.",
            },
            {
                topic: "At a Convenience Store (便利商店)",
                conversation: [
                    "Customer: Hi, I'd like this bottled water and a pack of tissues.",
                    "Clerk: Okay, that's 45 NTD in total.",
                    "Customer: Here's 50. Do you have a bag?",
                    "Clerk: Yes, we do. Here's your change and your items.",
                    "Customer: Thanks!",
                    "Clerk: You're welcome. Have a good day."
                ],
                chineseTranslation: "顧客：嗨，我想要這瓶水和一包面紙。\n店員：好的，總共新台幣45元。\n顧客：這是50元。你們有袋子嗎？\n店員：是的，我們有。這是你的找零和你的商品。\n顧客：謝謝！\n店員：不客氣。祝您有美好的一天。",
                question: "顧客除了水之外還買了什麼？",
                options: ["餅乾", "雜誌", "面紙", "口香糖"],
                correctAnswerIndex: 2,
                englishTranscript: "Customer: Hi, I'd like this bottled water and a pack of tissues.\nClerk: Okay, that's 45 NTD in total.\nCustomer: Here's 50. Do you have a bag?",
            },
            {
                topic: "Riding the MRT (搭捷運)",
                conversation: [
                    "Tourist: Excuse me, which line goes to Taipei Main Station?",
                    "Local: You need to take the Red Line. It's just two stops from here.",
                    "Tourist: The Red Line, two stops. Got it. Is it easy to transfer?",
                    "Local: Yes, very easy. All transfers are well-marked.",
                    "Tourist: Great! Thanks for the info.",
                    "Local: No problem, enjoy your ride!"
                ],
                chineseTranslation: "遊客：不好意思，哪條線到台北車站？\n當地人：你需要搭紅線。從這裡過去只有兩站。\n遊客：紅線，兩站。知道了。轉乘方便嗎？\n當地人：是的，非常方便。所有轉乘都有清楚標示。\n遊客：太好了！謝謝你的資訊。\n當地人：不客氣，祝你旅途愉快！",
                question: "遊客需要搭乘哪條捷運線前往台北車站？",
                options: ["藍線", "綠線", "紅線", "棕線"],
                correctAnswerIndex: 2,
                englishTranscript: "Tourist: Excuse me, which line goes to Taipei Main Station?\nLocal: You need to take the Red Line. It's just two stops from here.\nTourist: The Red Line, two stops. Got it. Is it easy to transfer?\nLocal: Yes, very easy. All transfers are well-marked.\nTourist: Great! Thanks for the info.\nLocal: No problem, enjoy your ride!"
            },
            {
                topic: "Booking Accommodation (預訂住宿)",
                conversation: [
                    "Guest: Hello, I'd like to book a room for two nights, starting tomorrow.",
                    "Receptionist: Let me check. For how many people?",
                    "Guest: Just one person.",
                    "Receptionist: Okay, we have a standard single room available. The rate is 2,500 NTD per night.",
                    "Guest: Sounds good. I'll take it.",
                    "Receptionist: Excellent! Can I get your name, please?"
                ],
                chineseTranslation: "客人：你好，我想預訂一間房間，明天開始住兩晚。\n接待員：讓我查一下。幾個人？\n客人：只有一個人。\n接待員：好的，我們有一間標準單人房。每晚費用是新台幣2,500元。\n客人：聽起來不錯。我訂了。\n接待員：太好了！請問您的姓名是？",
                question: "客人想預訂幾晚的房間？",
                options: ["一晚", "兩晚", "三晚", "四晚"],
                correctAnswerIndex: 1,
                englishTranscript: "Guest: Hello, I'd like to book a room for two nights, starting tomorrow.\nReceptionist: Let me check. For how many people?\nGuest: Just one person.\nReceptionist: Okay, we have a standard single room available. The rate is 2,500 NTD per night.\nGuest: Sounds good. I'll take it.\nReceptionist: Excellent! Can I get your name, please?"
            },
            {
                topic: "At a Bank/ATM (銀行/提款機)",
                conversation: [
                    "Customer: Excuse me, I'd like to exchange some currency.",
                    "Bank Teller: Certainly. What currency are you exchanging?",
                    "Customer: US dollars to New Taiwan dollars.",
                    "Bank Teller: Okay, please fill out this form. Do you have your passport?",
                    "Customer: Yes, here it is.",
                    "Bank Teller: Thank you. I'll process this for you."
                ],
                chineseTranslation: "顧客：不好意思，我想兌換一些貨幣。\n銀行櫃員：當然。您要兌換什麼貨幣？\n顧客：美元兌換新台幣。\n銀行櫃員：好的，請填寫這份表格。您有帶護照嗎？\n顧客：是的，在這裡。\n銀行櫃員：謝謝。我會為您辦理。",
                question: "顧客想把什麼貨幣兌換成新台幣？",
                options: ["日圓", "歐元", "美元", "人民幣"],
                correctAnswerIndex: 2,
                englishTranscript: "Customer: Excuse me, I'd like to exchange some currency.\nBank Teller: Certainly. What currency are you exchanging?\nCustomer: US dollars to New Taiwan dollars.\nBank Teller: Okay, please fill out this form. Do you have your passport?",
            },
            // --- 20 New Scenarios Below ---
            {
                topic: "Buying Fruit at a Traditional Market (傳統市場買水果)",
                conversation: [
                    "Customer: How much are these mangoes?",
                    "Vendor: They are 80 NTD per catty.",
                    "Customer: Can I get two, please? Are they sweet?",
                    "Vendor: Very sweet! Freshly picked this morning.",
                    "Customer: Great! I'll take them.",
                    "Vendor: Here you go. Enjoy!"
                ],
                chineseTranslation: "顧客：這些芒果多少錢？\n攤販：一斤80元。\n顧客：我買兩個，謝謝。它們甜嗎？\n攤販：非常甜！今天早上剛採的。\n顧客：太好了！我買了。\n攤販：給你。請享用！",
                question: "芒果的價格是多少？",
                options: ["一斤50元", "一斤60元", "一斤80元", "一斤100元"],
                correctAnswerIndex: 2,
                englishTranscript: "Customer: How much are these mangoes?\nVendor: They are 80 NTD per catty.\nCustomer: Can I get two, please? Are they sweet?\nVendor: Very sweet! Freshly picked this morning.\nCustomer: Great! I'll take them.\nVendor: Here you go. Enjoy!"
            },
            {
                topic: "Ordering Street Food (點小吃)",
                conversation: [
                    "Customer: I'd like one oyster omelette, please.",
                    "Vendor: Spicy or not spicy?",
                    "Customer: Not spicy, thank you. And one stinky tofu.",
                    "Vendor: Alright, that's 170 NTD. For here or to go?",
                    "Customer: To go, please.",
                    "Vendor: Coming right up!"
                ],
                chineseTranslation: "顧客：我想要一份蚵仔煎，謝謝。\n攤販：要辣的還是不辣的？\n顧客：不辣的，謝謝。還有一份臭豆腐。\n攤販：好的，總共170元。內用還是外帶？\n顧客：外帶，謝謝。\n攤販：馬上來！",
                question: "顧客點了哪兩種小吃？",
                options: ["滷肉飯和雞排", "蚵仔煎和臭豆腐", "牛肉麵和水餃", "蔥油餅和潤餅"],
                correctAnswerIndex: 1,
                englishTranscript: "Customer: I'd like one oyster omelette, please.\nVendor: Spicy or not spicy?\nCustomer: Not spicy, thank you. And one stinky tofu.\nVendor: Alright, that's 170 NTD. For here or to go?\nCustomer: To go, please.\nVendor: Coming right up!"
            },
            {
                topic: "Asking about Bus Routes/Fares (詢問公車路線/票價)",
                conversation: [
                    "Passenger: Excuse me, does this bus go to National Palace Museum?",
                    "Driver: No, you need bus number 304. This one goes to Shilin.",
                    "Passenger: Oh, I see. How much is the fare?",
                    "Driver: It's 15 NTD with an EasyCard, or 30 NTD cash.",
                    "Passenger: Thank you for the information.",
                    "Driver: You're welcome."
                ],
                chineseTranslation: "乘客：不好意思，這班公車有到故宮博物院嗎？\n司機：沒有，你需要搭304號公車。這班車到士林。\n乘客：喔，原來如此。票價多少？\n司機：用悠遊卡是15元，現金是30元。\n乘客：謝謝你的資訊。\n司機：不客氣。",
                question: "乘客需要搭乘哪一號公車才能到達故宮博物院？",
                options: ["208", "260", "304", "605"],
                correctAnswerIndex: 2,
                englishTranscript: "Passenger: Excuse me, does this bus go to National Palace Museum?\nDriver: No, you need bus number 304. This one goes to Shilin.\nPassenger: Oh, I see. How much is the fare?\nDriver: It's 15 NTD with an EasyCard, or 30 NTD cash.\nPassenger: Thank you for the information.\nDriver: You're welcome."
            },
            {
                topic: "Visiting a Night Market Game Stall (夜市遊戲攤位)",
                conversation: [
                    "Player: How much for one round of this balloon dart game?",
                    "Owner: 100 NTD for three darts!",
                    "Player: Okay, I'll try. What's the prize for hitting all balloons?",
                    "Owner: You can choose any large plush toy!",
                    "Player: Wow, that's cool! Here's the money.",
                    "Owner: Good luck!"
                ],
                chineseTranslation: "玩家：這個射氣球遊戲一輪多少錢？\n老闆：三支飛鏢100元！\n玩家：好，我試試看。射中所有氣球的獎品是什麼？\n老闆：你可以選任何一個大型絨毛玩具！\n玩家：哇，太棒了！錢給你。\n老闆：祝你好運！",
                question: "玩一次射氣球遊戲需要多少錢？",
                options: ["50元", "80元", "100元", "150元"],
                correctAnswerIndex: 2,
                englishTranscript: "Player: How much for one round of this balloon dart game?\nOwner: 100 NTD for three darts!\nPlayer: Okay, I'll try. What's the prize for hitting all balloons?\nOwner: You can choose any large plush toy!\nPlayer: Wow, that's cool! Here's the money.\nOwner: Good luck!"
            },
            {
                topic: "Asking for help with a Scooter Issue (機車問題求助)",
                conversation: [
                    "Rider: Excuse me, my scooter tire is flat. Is there a repair shop nearby?",
                    "Local: Oh, that's a pity. There's one just around the corner, on your right.",
                    "Rider: Around the corner, on the right. Got it. Is it open now?",
                    "Local: Yes, they usually open until late evening.",
                    "Rider: Thank you so much for your help!",
                    "Local: No problem at all."
                ],
                chineseTranslation: "騎車人：不好意思，我的機車輪胎沒氣了。附近有維修店嗎？\n當地人：喔，真可惜。就在轉角處，你右手邊有一家。\n騎車人：轉角處，右手邊。知道了。現在有開嗎？\n當地人：有，他們通常營業到很晚。\n騎車人：非常感謝您的幫助！\n當地人：一點問題都沒有。",
                question: "機車維修店在哪裡？",
                options: ["在左手邊", "在轉角處的右手邊", "在前方直走", "在對面"],
                correctAnswerIndex: 1,
                englishTranscript: "Rider: Excuse me, my scooter tire is flat. Is there a repair shop nearby?\nLocal: Oh, that's a pity. There's one just around the corner, on your right.\nRider: Around the corner, on the right. Got it. Is it open now?\nLocal: Yes, they usually open until late evening.\nRider: Thank you so much for your help!\nLocal: No problem at all."
            },
            {
                topic: "At a Local Clinic/Pharmacy (診所/藥局)",
                conversation: [
                    "Patient: Hello, I have a sore throat and a cough.",
                    "Receptionist: Please fill out this form. Do you have your NHI card?",
                    "Patient: Yes, here it is. How long is the wait?",
                    "Receptionist: About 20 minutes. The doctor will see you shortly.",
                    "Patient: Thank you.",
                    "Receptionist: You're welcome."
                ],
                chineseTranslation: "病人：你好，我喉嚨痛和咳嗽。\n接待員：請填寫這份表格。你有健保卡嗎？\n病人：是的，在這裡。大概要等多久？\n接待員：大約20分鐘。醫生很快就會看你。\n病人：謝謝。\n接待員：不客氣。",
                question: "病人有什麼症狀？",
                options: ["頭痛和發燒", "喉嚨痛和咳嗽", "肚子痛和噁心", "流鼻水和打噴嚏"],
                correctAnswerIndex: 1,
                englishTranscript: "Patient: Hello, I have a sore throat and a cough.\nReceptionist: Please fill out this form. Do you have your NHI card?\nPatient: Yes, here it is. How long is the wait?\nReceptionist: About 20 minutes. The doctor will see you shortly.\nPatient: Thank you.",
            },
            {
                topic: "Buying Tickets for a Train/HSR (買火車/高鐵票)",
                conversation: [
                    "Customer: I'd like a ticket to Kaohsiung, please. For the next available train.",
                    "Clerk: One moment. That would be the 10:45 AM HSR. Standard or business class?",
                    "Customer: Standard, please. How much is it?",
                    "Clerk: 1490 NTD. Cash or credit card?",
                    "Customer: Credit card. Thank you!",
                    "Clerk: Here's your ticket."
                ],
                chineseTranslation: "顧客：我想要一張到高雄的票，謝謝。搭下一班有空位的列車。\n售票員：請稍等。那是上午10:45的高鐵。標準車廂還是商務車廂？\n顧客：標準車廂，謝謝。多少錢？\n售票員：新台幣1490元。現金還是信用卡？\n顧客：信用卡。謝謝！\n售票員：這是你的票。",
                question: "顧客要搭乘哪種交通工具？",
                options: ["火車", "公車", "高鐵", "捷運"],
                correctAnswerIndex: 2,
                englishTranscript: "Customer: I'd like a ticket to Kaohsiung, please. For the next available train.\nClerk: One moment. That would be the 10:45 AM HSR. Standard or business class?\nCustomer: Standard, please. How much is it?\nClerk: 1490 NTD. Cash or credit card?\nCustomer: Credit card. Thank you!",
            },
            {
                topic: "Asking for Recommendations (詢問推薦)",
                conversation: [
                    "Tourist: We're looking for a good local restaurant. Any recommendations?",
                    "Local: Definitely try the beef noodle soup place on the next street. It's very famous.",
                    "Tourist: Beef noodle soup, sounds great! Is it expensive?",
                    "Local: Not at all. Very reasonable prices, and delicious!",
                    "Tourist: Perfect! We'll check it out. Thanks!",
                    "Local: Enjoy your meal!"
                ],
                chineseTranslation: "遊客：我們想找一家好的當地餐廳。有什麼推薦的嗎？\n當地人：絕對要試試下一條街的牛肉麵店。它很有名。\n遊客：牛肉麵，聽起來很棒！貴嗎？\n當地人：一點也不貴。價格非常合理，而且很好吃！\n遊客：太好了！我們會去看看。謝謝！\n當地人：祝你用餐愉快！",
                question: "當地人推薦了什麼食物？",
                options: ["滷肉飯", "蚵仔煎", "牛肉麵", "臭豆腐"],
                correctAnswerIndex: 2,
                englishTranscript: "Tourist: We're looking for a good local restaurant. Any recommendations?\nLocal: Definitely try the beef noodle soup place on the next street. It's very famous.\nTourist: Beef noodle soup, sounds great! Is it expensive?\nLocal: Not at all. Very reasonable prices, and delicious!\nTourist: Perfect! We'll check it out. Thanks!",
            },
            {
                topic: "Dealing with a Lost Item (處理遺失物)",
                conversation: [
                    "Person A: Oh no, I think I left my umbrella on the bus.",
                    "Person B: You should call the bus company's lost and found. Do you remember the bus number?",
                    "Person A: I think it was 262. Do you know their number?",
                    "Person B: I don't have it, but you can find it online easily.",
                    "Person A: Okay, I'll do that. Thanks for the advice.",
                    "Person B: Hope you find it!"
                ],
                chineseTranslation: "甲：喔不，我想我把雨傘忘在公車上了。\n乙：你應該打電話給公車公司的失物招領處。你記得公車號碼嗎？\n甲：我記得是262。你知道他們的電話號碼嗎？\n乙：我沒有，但你可以在網上很容易找到。\n甲：好的，我會去查。謝謝你的建議。\n乙：希望你找得到！",
                question: "甲在公車上遺失了什麼物品？",
                options: ["手機", "錢包", "雨傘", "背包"],
                correctAnswerIndex: 2,
                englishTranscript: "Person A: Oh no, I think I left my umbrella on the bus.\nPerson B: You should call the bus company's lost and found. Do you remember the bus number?\nPerson A: I think it was 262. Do you know their number?\nPerson B: I don't have it, but you can find it online easily.\nPerson A: Okay, I'll do that. Thanks for the advice.",
            },
            {
                topic: "Asking about Recycling/Garbage Rules (詢問垃圾分類規則)",
                conversation: [
                    "Resident: Excuse me, when is the garbage truck coming today?",
                    "Local: It usually comes around 7 PM, but it's often a bit late.",
                    "Resident: I see. And how do I sort the recycling?",
                    "Local: Paper, plastic, and glass are separate. Food waste goes in a different bucket.",
                    "Resident: Got it. Thanks for clarifying!",
                    "Local: No worries."
                ],
                chineseTranslation: "居民：不好意思，今天垃圾車什麼時候來？\n當地人：通常晚上7點左右來，但常常會晚一點。\n居民：喔，知道了。那回收物怎麼分類？\n當地人：紙類、塑膠和玻璃是分開的。廚餘要放另一個桶子。\n居民：明白了。謝謝你解釋清楚！\n當地人：不客氣。",
                question: "垃圾車通常什麼時候來？",
                options: ["早上8點", "中午12點", "晚上7點左右", "晚上9點"],
                correctAnswerIndex: 2,
                englishTranscript: "Resident: Excuse me, when is the garbage truck coming today?\nLocal: It usually comes around 7 PM, but it's often a bit late.\nResident: I see. And how do I sort the recycling?\nLocal: Paper, plastic, and glass are separate. Food waste goes in a different bucket.\nResident: Got it. Thanks for clarifying!",
            },
            {
                topic: "At a Post Office (郵局)",
                conversation: [
                    "Customer: I'd like to send this package to the UK, please.",
                    "Clerk: Alright. Would you prefer airmail or surface mail?",
                    "Customer: What's the difference in price and time?",
                    "Clerk: Airmail is faster, about 5-7 days, but more expensive. Surface mail is cheaper, but takes 4-6 weeks.",
                    "Customer: I'll go with airmail, please.",
                    "Clerk: Please fill out this customs form."
                ],
                chineseTranslation: "顧客：我想把這個包裹寄到英國，謝謝。\n櫃檯人員：好的。您想寄空運還是海運？\n顧客：價格和時間有什麼區別？\n櫃檯人員：空運比較快，大約5-7天，但比較貴。海運比較便宜，但需要4-6週。\n顧客：我選空運，謝謝。\n櫃檯人員：請填寫這份報關單。",
                question: "顧客想把包裹寄到哪裡？",
                options: ["美國", "日本", "英國", "加拿大"],
                correctAnswerIndex: 2,
                englishTranscript: "Customer: I'd like to send this package to the UK, please.\nClerk: Alright. Would you prefer airmail or surface mail?\nCustomer: What's the difference in price and time?\nClerk: Airmail is faster, about 5-7 days, but more expensive. Surface mail is cheaper, but takes 4-6 weeks.\nCustomer: I'll go with airmail, please.",
            },
            {
                topic: "Asking for Wi-Fi Password (詢問Wi-Fi密碼)",
                conversation: [
                    "Customer: Excuse me, do you have Wi-Fi here?",
                    "Staff: Yes, we do. The network name is 'CafeConnect'.",
                    "Customer: And what's the password?",
                    "Staff: It's 'coffeelover123'. All lowercase.",
                    "Customer: Got it. Thank you!",
                    "Staff: Enjoy your stay."
                ],
                chineseTranslation: "顧客：不好意思，這裡有Wi-Fi嗎？\n店員：是的，我們有。網路名稱是'CafeConnect'。\n顧客：那密碼是什麼？\n店員：是'coffeelover123'。全部小寫。\n顧客：知道了。謝謝！\n店員：祝您愉快。",
                question: "Wi-Fi的密碼是什麼？",
                options: ["freewifi", "cafe2024", "coffeelover123", "guestnetwork"],
                correctAnswerIndex: 2,
                englishTranscript: "Customer: Excuse me, do you have Wi-Fi here?\nStaff: Yes, we do. The network name is 'CafeConnect'.\nCustomer: And what's the password?\nStaff: It's 'coffeelover123'. All lowercase.\nCustomer: Got it. Thank you!",
            },
            {
                topic: "Hair Salon/Barber Shop (理髮店/美髮沙龍)",
                conversation: [
                    "Client: Hello, I'd like a haircut, please. Just a trim.",
                    "Stylist: Alright. How much would you like off?",
                    "Client: Just about an inch, to keep the length. And a little layering.",
                    "Stylist: No problem. Would you like a wash and blow-dry as well?",
                    "Client: Yes, please. Thank you!",
                    "Stylist: Please follow me."
                ],
                chineseTranslation: "顧客：你好，我想剪頭髮，謝謝。只要修剪一下就好。\n設計師：好的。你想剪掉多少？\n顧客：大約一英吋就好，保持長度。再加一點層次。\n設計師：沒問題。也需要洗髮和吹乾嗎？\n顧客：是的，謝謝。\n設計師：請跟我來。",
                question: "顧客想要怎樣的髮型服務？",
                options: ["染髮", "燙髮", "剪髮和分層", "護髮"],
                correctAnswerIndex: 2,
                englishTranscript: "Client: Hello, I'd like a haircut, please. Just a trim.\nStylist: Alright. How much would you like off?\nClient: Just about an inch, to keep the length. And a little layering.\nStylist: No problem. Would you like a wash and blow-dry as well?\nClient: Yes, please. Thank you!",
            },
            {
                topic: "Buying Souvenirs (買紀念品)",
                conversation: [
                    "Tourist: These pineapple cakes look delicious! How many come in a box?",
                    "Shopkeeper: There are 12 pieces in a box. They are very popular.",
                    "Tourist: I'll take two boxes, please. Are they fresh?",
                    "Shopkeeper: Baked this morning! They're our specialty.",
                    "Tourist: Perfect for gifts. Thank you!",
                    "Shopkeeper: You're welcome! Enjoy your trip."
                ],
                chineseTranslation: "遊客：這些鳳梨酥看起來很好吃！一盒有幾個？\n店主：一盒有12個。它們很受歡迎。\n遊客：我買兩盒，謝謝。它們新鮮嗎？\n店主：今天早上剛烤的！這是我們的特色產品。\n遊客：非常適合當禮物。謝謝！\n店主：不客氣！祝您旅途愉快。",
                question: "一盒鳳梨酥有幾塊？",
                options: ["6塊", "8塊", "10塊", "12塊"],
                correctAnswerIndex: 3,
                englishTranscript: "Tourist: These pineapple cakes look delicious! How many come in a box?\nShopkeeper: There are 12 pieces in a box. They are very popular.\nTourist: I'll take two boxes, please. Are they fresh?\nShopkeeper: Baked this morning! They're our specialty.\nTourist: Perfect for gifts. Thank you!",
            },
            {
                topic: "Asking about Opening Hours (詢問營業時間)",
                conversation: [
                    "Customer: Excuse me, what time do you close today?",
                    "Staff: We close at 9 PM on weekdays.",
                    "Customer: And on weekends?",
                    "Staff: On Saturdays and Sundays, we close at 10 PM.",
                    "Customer: Okay, thank you! I'll come back later.",
                    "Staff: See you then!"
                ],
                chineseTranslation: "顧客：不好意思，你們今天幾點關門？\n店員：我們平日晚上9點關門。\n顧客：那週末呢？\n店員：週六和週日，我們晚上10點關門。\n顧客：好的，謝謝！我晚點再來。\n店員：到時見！",
                question: "這家店週末幾點關門？",
                options: ["晚上8點", "晚上9點", "晚上10點", "晚上11點"],
                correctAnswerIndex: 2,
                englishTranscript: "Customer: Excuse me, what time do you close today?\nStaff: We close at 9 PM on weekdays.\nCustomer: And on weekends?\nStaff: On Saturdays and Sundays, we close at 10 PM.\nCustomer: Okay, thank you! I'll come back later.",
            },
            {
                topic: "At a Laundromat (自助洗衣店)",
                conversation: [
                    "Customer: How much does it cost to use the washing machine?",
                    "Attendant: It's 50 NTD for a small load, 80 for a large.",
                    "Customer: And for the dryer?",
                    "Attendant: 10 NTD for 10 minutes. Do you need detergent?",
                    "Customer: No, I have my own. Thanks!",
                    "Attendant: You're welcome."
                ],
                chineseTranslation: "顧客：洗衣機要多少錢？\n服務員：小容量50元，大容量80元。\n顧客：那烘衣機呢？\n服務員：10分鐘10元。你需要洗衣精嗎？\n顧客：不用，我有自己的。謝謝！\n服務員：不客氣。",
                question: "烘衣機每10分鐘的費用是多少？",
                options: ["5元", "10元", "15元", "20元"],
                correctAnswerIndex: 1,
                englishTranscript: "Customer: How much does it cost to use the washing machine?\nAttendant: It's 50 NTD for a small load, 80 for a large.\nCustomer: And for the dryer?\nAttendant: 10 NTD for 10 minutes. Do you need detergent?\nCustomer: No, I have my own. Thanks!",
            },
            {
                topic: "Ordering Coffee at a Cafe (咖啡廳點咖啡)",
                conversation: [
                    "Barista: What can I get for you?",
                    "Customer: I'd like a hot latte, please. With oat milk.",
                    "Barista: Oat milk latte, got it. Anything else?",
                    "Customer: Yes, and a slice of cheesecake.",
                    "Barista: Okay, that'll be 220 NTD. For here or to go?",
                    "Customer: For here, please."
                ],
                chineseTranslation: "咖啡師：您想點什麼？\n顧客：我想要一杯熱拿鐵，謝謝。用燕麥奶。\n咖啡師：燕麥奶拿鐵，好的。還有別的嗎？\n顧客：是的，再加一片起司蛋糕。\n咖啡師：好的，總共220元。內用還是外帶？\n顧客：內用，謝謝。",
                question: "顧客點了什麼飲料？",
                options: ["美式咖啡", "卡布奇諾", "熱拿鐵", "冰咖啡"],
                correctAnswerIndex: 2,
                englishTranscript: "Barista: What can I get for you?\nCustomer: I'd like a hot latte, please. With oat milk.\nBarista: Oat milk latte, got it. Anything else?\nCustomer: Yes, and a slice of cheesecake.\nBarista: Okay, that'll be 220 NTD. For here or to go?",
            },
            {
                topic: "Asking about Local Festivals/Events (詢問當地節慶/活動)",
                conversation: [
                    "Tourist: Is there anything special happening in Taipei this weekend?",
                    "Local: Yes, there's a Lantern Festival celebration at the park on Saturday evening.",
                    "Tourist: Oh, that sounds interesting! What time does it start?",
                    "Local: The main event begins at 6 PM, but you can go earlier to see the lanterns.",
                    "Tourist: Perfect! Thank you for the information.",
                    "Local: Enjoy the festival!"
                ],
                chineseTranslation: "遊客：這個週末台北有什麼特別的活動嗎？\n當地人：有，週六晚上公園有元宵節慶祝活動。\n遊客：喔，聽起來很有趣！什麼時候開始？\n當地人：主要活動晚上6點開始，但你可以早點去看看燈籠。\n遊客：太好了！謝謝你的資訊。\n當地人：祝你節日愉快！",
                question: "這個週末台北有什麼活動？",
                options: ["音樂會", "美食展", "元宵節慶祝活動", "運動比賽"],
                correctAnswerIndex: 2,
                englishTranscript: "Tourist: Is there anything special happening in Taipei this weekend?\nLocal: Yes, there's a Lantern Festival celebration at the park on Saturday evening.\nTourist: Oh, that sounds interesting! What time does it start?",
            },
            {
                topic: "Renting a Bicycle (租借自行車)",
                conversation: [
                    "Renter: Hi, I'd like to rent a bicycle for a few hours.",
                    "Clerk: Sure, we have mountain bikes and city bikes. Which one do you prefer?",
                    "Renter: A city bike, please. How much is it per hour?",
                    "Clerk: It's 50 NTD per hour, or 200 NTD for the whole day.",
                    "Renter: I'll take it for three hours. Do I need to leave a deposit?",
                    "Clerk: Just your ID is fine. Enjoy your ride!"
                ],
                chineseTranslation: "租借人：你好，我想租一輛自行車幾個小時。\n店員：好的，我們有登山車和城市自行車。你喜歡哪一種？\n租借人：城市自行車，謝謝。每小時多少錢？\n店員：每小時50元，或者整天200元。\n租借人：我租三個小時。需要押金嗎？\n店員：只要你的身份證就可以了。祝你騎行愉快！",
                question: "租借城市自行車一小時的費用是多少？",
                options: ["30元", "40元", "50元", "60元"],
                correctAnswerIndex: 2,
                englishTranscript: "Renter: Hi, I'd like to rent a bicycle for a few hours.\nClerk: Sure, we have mountain bikes and city bikes. Which one do you prefer?\nRenter: A city bike, please. How much is it per hour?\nClerk: It's 50 NTD per hour, or 200 NTD for the whole day.\nRenter: I'll take it for three hours. Do I need to leave a deposit?",
            },
            {
                topic: "Asking for the Restroom (詢問洗手間)",
                conversation: [
                    "Customer: Excuse me, where is the restroom?",
                    "Staff: It's downstairs, to your left.",
                    "Customer: Downstairs, left. Got it. Is it free to use?",
                    "Staff: Yes, it is. Just follow the signs.",
                    "Customer: Thank you very much!",
                    "Staff: No problem."
                ],
                chineseTranslation: "顧客：不好意思，洗手間在哪裡？\n店員：在樓下，你左手邊。\n顧客：樓下，左手邊。知道了。可以免費使用嗎？\n店員：是的，可以。跟著指示牌走就好。\n顧客：非常感謝！\n店員：不客氣。",
                question: "洗手間在哪裡？",
                options: ["樓上", "樓下右手邊", "樓下左手邊", "外面"],
                correctAnswerIndex: 2,
                englishTranscript: "Customer: Excuse me, where is the restroom?\nStaff: It's downstairs, to your left.\nCustomer: Downstairs, left. Got it. Is it free to use?\nStaff: Yes, it is. Just follow the signs.\nCustomer: Thank you very much!",
            },
            {
                topic: "At a Supermarket (超市購物)",
                conversation: [
                    "Customer: Excuse me, where can I find the milk?",
                    "Staff: The dairy section is in aisle 3, on your right.",
                    "Customer: Aisle 3, right. Thank you. Do you have organic milk?",
                    "Staff: Yes, we have a few brands. They're on the top shelf.",
                    "Customer: Great! Thanks for your help.",
                    "Staff: My pleasure."
                ],
                chineseTranslation: "顧客：不好意思，請問牛奶在哪裡？\n店員：乳製品區在第三排，你右手邊。\n顧客：第三排，右手邊。謝謝。你們有有機牛奶嗎？\n店員：是的，我們有幾個品牌。它們在最上面的架子上。\n顧客：太好了！謝謝你的幫助。\n店員：不客氣。",
                question: "牛奶在哪個區域？",
                options: ["冷凍食品區", "零食區", "乳製品區", "熟食區"],
                correctAnswerIndex: 2,
                englishTranscript: "Customer: Excuse me, where can I find the milk?\nStaff: The dairy section is in aisle 3, on your right.\nCustomer: Aisle 3, right. Thank you. Do you have organic milk?\nStaff: Yes, we have a few brands. They're on the top shelf.\nCustomer: Great! Thanks for your help.",
            },
            {
                topic: "Buying a SIM Card (購買SIM卡)",
                conversation: [
                    "Customer: Hello, I need a local SIM card for my phone.",
                    "Clerk: Alright. How long will you be staying in Taiwan?",
                    "Customer: For about two weeks.",
                    "Clerk: We have a 15-day plan with unlimited data for 500 NTD. Is that suitable?",
                    "Customer: Yes, that sounds perfect. I'll take that one.",
                    "Clerk: Please show me your passport for registration."
                ],
                chineseTranslation: "顧客：你好，我需要一張當地的手機SIM卡。\n店員：好的。你預計在台灣待多久？\n顧客：大約兩週。\n店員：我們有15天無限上網方案，500元。這個適合嗎？\n顧客：是的，聽起來很完美。我就要那個。\n店員：請出示您的護照進行登記。",
                question: "顧客想在台灣停留多久？",
                options: ["一週", "兩週", "一個月", "三個月"],
                correctAnswerIndex: 1,
                englishTranscript: "Customer: Hello, I need a local SIM card for my phone.\nClerk: Alright. How long will you be staying in Taiwan?\nCustomer: For about two weeks.\nClerk: We have a 15-day plan with unlimited data for 500 NTD. Is that suitable?\nCustomer: Yes, that sounds perfect. I'll take that one.",
            },
            {
                topic: "At a Traditional Chinese Medicine Clinic (中醫診所)",
                conversation: [
                    "Patient: Good morning, I'm here for acupuncture.",
                    "Receptionist: Please take a seat. Have you been here before?",
                    "Patient: No, it's my first time. I have shoulder pain.",
                    "Receptionist: Okay, the doctor will see you in about 15 minutes. Please fill out this health form.",
                    "Patient: Thank you.",
                    "Receptionist: You're welcome."
                ],
                chineseTranslation: "病人：早安，我來針灸的。\n接待員：請坐。您以前來過嗎？\n病人：沒有，這是第一次。我肩膀痛。\n接待員：好的，醫生大約15分鐘後會看您。請填寫這份健康表格。\n病人：謝謝。\n接待員：不客氣。",
                question: "病人來診所是為了什麼？",
                options: ["拔牙", "針灸", "視力檢查", "打疫苗"],
                correctAnswerIndex: 1,
                englishTranscript: "Patient: Good morning, I'm here for acupuncture.\nReceptionist: Please take a seat. Have you been here before?\nPatient: No, it's my first time. I have shoulder pain.\nReceptionist: Okay, the doctor will see you in about 15 minutes. Please fill out this health form.",
            },
            {
                topic: "Asking for a Recommendation for a Local Snack (詢問當地點心推薦)",
                conversation: [
                    "Tourist: I'm looking for a famous local snack. What do you recommend?",
                    "Local: You must try Sun Cakes! They are a specialty from Taichung.",
                    "Tourist: Sun Cakes? What are they like?",
                    "Local: They're sweet, flaky pastries, often with a maltose filling. Very delicious with tea.",
                    "Tourist: Sounds wonderful! Where can I buy them?",
                    "Local: There's a famous shop just two blocks away."
                ],
                chineseTranslation: "遊客：我在找一種有名的當地點心。你推薦什麼？\n當地人：你一定要試試太陽餅！那是台中特產。\n遊客：太陽餅？它是什麼樣的？\n當地人：它們是甜的、酥脆的糕點，通常有麥芽糖內餡。配茶非常好吃。\n遊客：聽起來很棒！在哪裡可以買到？\n當地人：離這裡兩條街就有一家有名的店。",
                question: "當地人推薦的點心是什麼？",
                options: ["鳳梨酥", "太陽餅", "牛舌餅", "綠豆椪"],
                correctAnswerIndex: 1,
                englishTranscript: "Tourist: I'm looking for a famous local snack. What do you recommend?\nLocal: You must try Sun Cakes! They are a specialty from Taichung.\nTourist: Sun Cakes? What are they like?\nLocal: They're sweet, flaky pastries, often with a maltose filling. Very delicious with tea.\nTourist: Sounds wonderful! Where can I buy them?",
            },
            {
                topic: "At a Traditional Tea House (茶藝館)",
                conversation: [
                    "Customer: Hello, we'd like to experience a traditional tea ceremony.",
                    "Teahouse Staff: Welcome! We have several types of oolong tea. Would you like a lighter or stronger flavour?",
                    "Customer: A lighter one, please. Which tea do you recommend for beginners?",
                    "Teahouse Staff: High Mountain Oolong is a good choice. It's very fragrant and smooth.",
                    "Customer: Sounds perfect. Thank Thank you!",
                    "Teahouse Staff: Please follow me to your table."
                ],
                chineseTranslation: "顧客：你好，我們想體驗傳統茶道。\n茶館員工：歡迎！我們有幾種烏龍茶。您喜歡清淡一點還是濃郁一點的口味？\n顧客：清淡一點的，謝謝。初學者推薦哪種茶？\n茶館員工：高山烏龍是個不錯的選擇。它非常芬芳順口。\n顧客：聽起來很完美。謝謝！\n茶館員工：請跟我到您的座位。",
                question: "茶館員工向初學者推薦了哪種茶？",
                options: ["普洱茶", "綠茶", "高山烏龍", "紅茶"],
                correctAnswerIndex: 2,
                englishTranscript: "Customer: Hello, we'd like to experience a traditional tea ceremony.\nTeahouse Staff: Welcome! We have several types of oolong tea. Would you like a lighter or stronger flavour?\nCustomer: A lighter one, please. Which tea do you recommend for beginners?\nTeahouse Staff: High Mountain Oolong is a good choice. It's very fragrant and smooth.\nCustomer: Sounds perfect. Thank you!",
            },
            {
                topic: "Asking for help with a broken phone (手機故障求助)",
                conversation: [
                    "Customer: Excuse me, my phone screen is cracked. Can you fix it?",
                    "Technician: Let me take a look. Yes, we can replace the screen. Which model is it?",
                    "Customer: It's an iPhone 13. How long will it take?",
                    "Technician: About an hour, if we have the part in stock. The cost is 3,500 NTD.",
                    "Customer: Okay, please fix it. Thank you!",
                    "Technician: We'll call you when it's ready."
                ],
                chineseTranslation: "顧客：不好意思，我的手機螢幕裂了。你們能修嗎？\n技術員：我看看。是的，我們可以更換螢幕。這是什麼型號？\n顧客：是iPhone 13。需要多久？\n技術員：如果我們有零件庫存，大約一小時。費用是新台幣3,500元。\n顧客：好的，請幫我修。謝謝！\n技術員：修好後我們會打電話給您。",
                question: "顧客的手機有什麼問題？",
                options: ["無法開機", "電池沒電", "螢幕破裂", "無法上網"],
                correctAnswerIndex: 2,
                englishTranscript: "Customer: Excuse me, my phone screen is cracked. Can you fix it?\nTechnician: Let me take a look. Yes, we can replace the screen. Which model is it?\nCustomer: It's an iPhone 13. How long will it take?\nTechnician: About an hour, if we have the part in stock. The cost is 3,500 NTD.\nCustomer: Okay, please fix it. Thank you!",
            },
            {
                topic: "At a Museum/Art Gallery (博物館/美術館)",
                conversation: [
                    "Visitor: This exhibition is fascinating! What's the story behind this painting?",
                    "Docent: This piece depicts a local fishing village in the 1950s. The artist used vibrant colors to capture the lively atmosphere.",
                    "Visitor: It's very expressive. Is photography allowed?",
                    "Docent: Flash photography is not permitted, but you can take pictures without flash.",
                    "Visitor: Understood. Thank you for the explanation.",
                    "Docent: My pleasure. Enjoy the rest of the exhibition."
                ],
                chineseTranslation: "參觀者：這個展覽真引人入勝！這幅畫背後的故事是什麼？\n導覽員：這幅作品描繪了1950年代的一個當地漁村。藝術家運用鮮豔的色彩捕捉生動的氛圍。\n參觀者：它非常有表現力。可以拍照嗎？\n導覽員：不允許使用閃光燈，但可以不使用閃光燈拍照。\n參觀者：明白了。謝謝你的解釋。\n導覽員：不客氣。祝您觀展愉快。",
                question: "在這間博物館裡，哪種拍照方式不被允許？",
                options: ["手機拍照", "無閃光燈拍照", "使用閃光燈拍照", "錄影"],
                correctAnswerIndex: 2,
                englishTranscript: "Visitor: This exhibition is fascinating! What's the story behind this painting?\nDocent: This piece depicts a local fishing village in the 1950s. The artist used vibrant colors to capture the lively atmosphere.\nVisitor: It's very expressive. Is photography allowed?\nDocent: Flash photography is not permitted, but you can take pictures without flash.\nVisitor: Understood. Thank you for the explanation.",
            },
            {
                topic: "Asking for a recommendation for a hiking trail (詢問登山步道推薦)",
                conversation: [
                    "Hiker: Excuse me, we're looking for a good hiking trail with nice views.",
                    "Local: I recommend Elephant Mountain. It's a bit steep but offers amazing views of Taipei 101.",
                    "Hiker: Elephant Mountain, sounds good! How long does it take to reach the top?",
                    "Local: About 20-30 minutes, depending on your pace. It's quite popular.",
                    "Hiker: Perfect! We'll give it a try. Thanks for the tip!",
                    "Local: Enjoy the hike!"
                ],
                chineseTranslation: "登山客：不好意思，我們想找一條風景好的登山步道。\n當地人：我推薦象山。雖然有點陡峭，但可以欣賞到台北101的絕佳景色。\n登山客：象山，聽起來不錯！爬到山頂大約需要多久？\n當地人：大約20-30分鐘，取決於你的速度。它很受歡迎。\n登山客：太好了！我們會去試試看。謝謝你的建議！\n當地人：祝你登山愉快！",
                question: "當地人推薦了哪座山？",
                options: ["陽明山", "七星山", "象山", "合歡山"],
                correctAnswerIndex: 2,
                englishTranscript: "Hiker: Excuse me, we're looking for a good hiking trail with nice views.\nLocal: I recommend Elephant Mountain. It's a bit steep but offers amazing views of Taipei 101.\nHiker: Elephant Mountain, sounds good! How long does it take to reach the top?\nLocal: About 20-30 minutes, depending on your pace. It's quite popular.\nHiker: Perfect! We'll give it a try. Thanks for the tip!",
            },
            {
                topic: "At a Hot Spring Resort (溫泉會館)",
                conversation: [
                    "Guest: Hello, we'd like to book a private hot spring room.",
                    "Receptionist: Certainly. For how long would you like to use it?",
                    "Guest: One hour, please. Is there a public area as well?",
                    "Receptionist: Yes, we have a large public hot spring area with different pools.",
                    "Guest: Great! What's the cost for the private room?",
                    "Receptionist: It's 800 NTD per hour. Please follow me."
                ],
                chineseTranslation: "客人：你好，我們想預訂一間私人溫泉房。\n接待員：當然。您想使用多久？\n客人：一小時，謝謝。也有公共區域嗎？\n接待員：是的，我們有一個大型公共溫泉區，有不同的池子。\n客人：太好了！私人房間的費用是多少？\n接待員：每小時800元。請跟我來。",
                question: "客人想預訂私人溫泉房多久？",
                options: ["半小時", "一小時", "一個半小時", "兩小時"],
                correctAnswerIndex: 1,
                englishTranscript: "Guest: Hello, we'd like to book a private hot spring room.\nReceptionist: Certainly. For how long would you like to use it?\nGuest: One hour, please. Is there a public area as well?\nReceptionist: Yes, we have a large public hot spring area with different pools.\nGuest: Great! What's the cost for the private room?",
            },
            {
                topic: "Buying a Souvenir at a Gift Shop (禮品店買紀念品)",
                conversation: [
                    "Customer: I'm looking for a small gift for my friend. Do you have anything unique from Taiwan?",
                    "Shopkeeper: We have these beautiful aboriginal handcrafted items, like carved wooden figures or woven bags.",
                    "Customer: They look lovely! How much is this small wooden owl?",
                    "Shopkeeper: That one is 450 NTD. It's handmade by a local artist.",
                    "Customer: I'll take it! It's perfect. Thank you!",
                    "Shopkeeper: You're welcome. I'll wrap it for you."
                ],
                chineseTranslation: "顧客：我在找一個送給朋友的小禮物。你們有什麼台灣獨特的嗎？\n店主：我們有這些美麗的原住民手工藝品，像是木雕人偶或編織包。\n顧客：它們看起來很可愛！這個小木貓頭鷹多少錢？\n店主：那個是新台幣450元。是當地藝術家手工製作的。\n顧客：我要了！它很完美。謝謝！\n店主：不客氣。我幫你包起來。",
                question: "顧客最終購買了什麼紀念品？",
                options: ["編織包", "木雕人偶", "鳳梨酥", "小木貓頭鷹"],
                correctAnswerIndex: 3,
                englishTranscript: "Customer: I'm looking for a small gift for my friend. Do you have anything unique from Taiwan?\nShopkeeper: We have these beautiful aboriginal handcrafted items, like carved wooden figures or woven bags.\nCustomer: They look lovely! How much is this small wooden owl?\nShopkeeper: That one is 450 NTD. It's handmade by a local artist.\nCustomer: I'll take it! It's perfect. Thank you!",
            },
            {
                topic: "At a KTV (KTV唱歌)",
                conversation: [
                    "Friend A: Let's sing some songs! What do you want to sing first?",
                    "Friend B: How about a duet? Do you know 'A Whole New World'?",
                    "Friend A: Oh, I love that one! Let's search for it. Do they have English songs here?",
                    "Friend B: Yes, they have a huge selection of English and Chinese songs.",
                    "Friend A: Awesome! This is going to be fun.",
                    "Friend B: Definitely!"
                ],
                chineseTranslation: "朋友A：我們來唱歌吧！你先想唱什麼？\n朋友B：合唱怎麼樣？你會唱《A Whole New World》嗎？\n朋友A：喔，我超愛那首！我們來找找看。這裡有英文歌嗎？\n朋友B：有，他們有大量的英文歌和中文歌。\n朋友A：太棒了！這會很有趣。\n朋友B：當然！",
                question: "朋友B提議唱哪首歌？",
                options: ["Let It Go", "Perfect", "A Whole New World", "Despacito"],
                correctAnswerIndex: 2,
                englishTranscript: "Friend A: Let's sing some songs! What do you want to sing first?\nFriend B: How about a duet? Do you know 'A Whole New World'?",
            },
            {
                topic: "At a Temple Fair (廟會)",
                conversation: [
                    "Visitor: Wow, this temple fair is so lively! What's happening with the parade?",
                    "Local: That's a traditional Mazu procession. People are celebrating the goddess Mazu.",
                    "Visitor: It's incredible! Are those firecrackers part of the celebration?",
                    "Local: Yes, they're used to ward off evil spirits and add to the festive atmosphere.",
                    "Visitor: Fascinating! I've never seen anything like this.",
                    "Local: It's a very important cultural event here."
                ],
                chineseTranslation: "參觀者：哇，這個廟會好熱鬧！遊行在做什麼？\n當地人：那是傳統的媽祖遶境。人們正在慶祝媽祖女神。\n參觀者：太不可思議了！那些鞭炮是慶祝活動的一部分嗎？\n當地人：是的，它們用來驅邪並增添節慶氣氛。\n參觀者：真引人入勝！我從沒見過這樣的景象。\n當地人：這是這裡非常重要的文化活動。",
                question: "遊行是為了慶祝哪位神祇？",
                options: ["關公", "玉皇大帝", "媽祖", "土地公"],
                correctAnswerIndex: 2,
                englishTranscript: "Visitor: Wow, this temple fair is so lively! What's happening with the parade?\nLocal: That's a traditional Mazu procession. People are celebrating the goddess Mazu.\nVisitor: It's incredible! Are those firecrackers part of the celebration?\nLocal: Yes, they're used to ward off evil spirits and add to the festive atmosphere.\nVisitor: Fascinating! I've never seen anything like this.",
            },
            {
                topic: "Asking for a receipt (索取收據)",
                conversation: [
                    "Customer: Can I get a receipt, please?",
                    "Clerk: Certainly. Do you need a uniform invoice (發票)?",
                    "Customer: Yes, please. For tax purposes.",
                    "Clerk: No problem. Here's your invoice. Good luck with the lottery!",
                    "Customer: Oh, right! Thank you!",
                    "Clerk: You're welcome."
                ],
                chineseTranslation: "顧客：可以給我一張收據嗎？\n店員：當然。你需要統一發票嗎？\n顧客：是的，謝謝。為了報稅。\n店員：沒問題。這是你的發票。祝你中獎！\n顧客：喔，對！謝謝！\n店員：不客氣。",
                question: "顧客除了收據之外還要求了什麼？",
                options: ["塑膠袋", "找零", "統一發票", "會員卡"],
                correctAnswerIndex: 2,
                englishTranscript: "Customer: Can I get a receipt, please?\nClerk: Certainly. Do you need a uniform invoice (發票)?\nCustomer: Yes, please. For tax purposes.\nClerk: No problem. Here's your invoice. Good luck with the lottery!\nCustomer: Oh, right! Thank you!",
            },
            {
                topic: "At a Bubble Tea Shop (手搖飲店)",
                conversation: [
                    "Customer: Hi, I'd like a medium-sized passion fruit green tea.",
                    "Staff: Half sugar, regular ice?",
                    "Customer: No, actually, 30% sugar and less ice, please.",
                    "Staff: 30% sugar, less ice. Got it. Anything else?",
                    "Customer: That's all. Thank you!",
                    "Staff: That'll be 60 NTD."
                ],
                chineseTranslation: "顧客：你好，我想要一杯中杯百香果綠茶。\n店員：半糖，正常冰嗎？\n顧客：不，其實是三分糖，少冰，謝謝。\n店員：三分糖，少冰。好的。還有別的嗎？\n顧客：就這些了。謝謝！\n店員：總共60元。",
                question: "顧客對飲料的甜度和冰塊量有什麼特別要求？",
                options: ["全糖多冰", "半糖少冰", "三分糖少冰", "無糖正常冰"],
                correctAnswerIndex: 2,
                englishTranscript: "Customer: Hi, I'd like a medium-sized passion fruit green tea.\nStaff: Half sugar, regular ice?\nCustomer: No, actually, 30% sugar and less ice, please.",
            },
            {
                topic: "Asking for help with directions at a train station (火車站問路)",
                conversation: [
                    "Traveler: Excuse me, where is the platform for trains heading south?",
                    "Staff: Southbound trains usually depart from platforms 1 and 2. You can check the electronic board for your specific train.",
                    "Traveler: Platforms 1 and 2. Thank you. Is there an elevator to the platforms?",
                    "Staff: Yes, there's one near the ticket gates.",
                    "Traveler: Great! Thanks for your help.",
                    "Staff: Have a safe journey."
                ],
                chineseTranslation: "旅客：不好意思，往南的列車月台在哪裡？\n站務人員：往南的列車通常從1號和2號月台發車。您可以查看電子看板確認您的具體列車。\n旅客：1號和2號月台。謝謝。有電梯到月台嗎？\n站務人員：有，在驗票閘門附近。\n旅客：太好了！謝謝你的幫助。\n站務人員：祝您旅途平安。",
                question: "往南的列車通常從哪個月台發車？",
                options: ["3號和4號月台", "1號和2號月台", "5號和6號月台", "只有1號月台"],
                correctAnswerIndex: 1,
                englishTranscript: "Traveler: Excuse me, where is the platform for trains heading south?\nStaff: Southbound trains usually depart from platforms 1 and 2. You can check the electronic board for your specific train.\nTraveler: Platforms 1 and 2. Thank you. Is there an elevator to the platforms?\nStaff: Yes, there's one near the ticket gates.\nTraveler: Great! Thanks for your help.",
            },
            {
                topic: "At a Traditional Breakfast Shop (傳統早餐店)",
                conversation: [
                    "Customer: I'd like one danbing (egg pancake roll) with cheese, and a hot soy milk.",
                    "Clerk: Cheese danbing and hot soy milk, got it. Anything else?",
                    "Customer: Yes, and one fan-tuan (rice ball) with pork floss.",
                    "Clerk: Pork floss fan-tuan. That'll be 110 NTD. For here or to go?",
                    "Customer: To go, please.",
                    "Clerk: Coming right up!"
                ],
                chineseTranslation: "顧客：我想要一份起司蛋餅和一杯熱豆漿。\n店員：起司蛋餅和熱豆漿，好的。還有別的嗎？\n顧客：是的，再加一個肉鬆飯糰。\n店員：肉鬆飯糰。總共110元。內用還是外帶？\n顧客：外帶，謝謝。\n店員：馬上就好！",
                question: "顧客點了哪兩種食物？",
                options: ["三明治和紅茶", "漢堡和奶茶", "蛋餅和飯糰", "燒餅油條和米漿"],
                correctAnswerIndex: 2,
                englishTranscript: "Customer: I'd like one danbing (egg pancake roll) with cheese, and a hot soy milk.\nClerk: Cheese danbing and hot soy milk, got it. Anything else?\nCustomer: Yes, and one fan-tuan (rice ball) with pork floss.\nClerk: Pork floss fan-tuan. That'll be 110 NTD. For here or to go?",
            },
            {
                topic: "Asking for a power outlet (詢問插座)",
                conversation: [
                    "Customer: Excuse me, do you have any available power outlets here?",
                    "Staff: Yes, there are a few near the window seats, and some under the bar counter.",
                    "Customer: Great, my phone battery is almost dead. Can I use one?",
                    "Staff: Of course. Feel free to use any that are free.",
                    "Customer: Thank you so much!",
                    "Staff: No problem."
                ],
                chineseTranslation: "顧客：不好意思，這裡有可用的插座嗎？\n店員：有，窗邊座位附近有幾個，吧台下方也有一些。\n顧客：太好了，我手機快沒電了。我可以用一個嗎？\n店員：當然。隨意使用任何空閒的插座。\n顧客：非常感謝！\n店員：不客氣。",
                question: "顧客為什麼需要插座？",
                options: ["想充電", "想使用吹風機", "想連接筆記型電腦", "想使用電磁爐"],
                correctAnswerIndex: 0,
                englishTranscript: "Customer: Excuse me, do you have any available power outlets here?\nStaff: Yes, there are a few near the window seats, and some under the bar counter.\nCustomer: Great, my phone battery is almost dead. Can I use one?\nStaff: Of course. Feel free to use any that are free.\nCustomer: Thank you so much!",
            },
            {
                topic: "At a Traditional Wet Market (傳統菜市場)",
                conversation: [
                    "Customer: Good morning! How fresh are these fish?",
                    "Vendor: Good morning! They were just caught last night. Very fresh!",
                    "Customer: I'll take two of the smaller ones, please. Can you clean them for me?",
                    "Vendor: Yes, no problem. Do you want them scaled and gutted?",
                    "Customer: Yes, please. Thank you!",
                    "Vendor: Coming right up."
                ],
                chineseTranslation: "顧客：早安！這些魚新鮮嗎？\n攤販：早安！它們是昨晚剛捕的。非常新鮮！\n顧客：我買兩條小一點的，謝謝。可以幫我處理一下嗎？\n攤販：可以，沒問題。你要去鱗和去內臟嗎？\n顧客：是的，謝謝。\n攤販：馬上就好。",
                question: "顧客想買什麼？",
                options: ["蔬菜", "肉類", "魚", "水果"],
                correctAnswerIndex: 2,
                englishTranscript: "Customer: Good morning! How fresh are these fish?\nVendor: Good morning! They were just caught last night. Very fresh!\nCustomer: I'll take two of the smaller ones, please. Can you clean them for me?\nVendor: Yes, no problem. Do you want them scaled and gutted?\nCustomer: Yes, please. Thank you!",
            }
        ];
        let currentScenarioIndex = 0;
        let selectedOptionIndex = -1; // To track the user's selected option for the quiz

        // Speaker voice configuration
        const speakerColors = ['text-blue-700', 'text-green-700', 'text-purple-700', 'text-red-700', 'text-indigo-700'];
        let speakerMap = {}; // Maps speaker name (e.g., "Tourist") to an index for color/voice
        let speakerVoiceMap = {}; // Maps speaker name to a SpeechSynthesisVoice object

        // --- Utility Functions ---

        /**
         * Displays a message in the global message box.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'error', 'info', 'warning'. Determines styling.
         */
        function showMessageBox(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = 'message-box show'; // Reset classes first
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
            } else if (type === 'warning') {
                messageBox.classList.add('bg-yellow-100', 'border-yellow-400', 'text-yellow-700');
            } else { // info
                messageBox.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700');
            }
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 5000); // Hide after 5 seconds
        }

        /**
         * Normalizes text for comparison (removes punctuation, converts to lowercase).
         * @param {string} text - The input text.
         * @returns {string} Normalized text.
         */
        function normalizeText(text) {
            return text.toLowerCase().replace(/[.,/#!$%^&*;:{}=\-_`~()?'"]/g, '').replace(/\s{2,}/g, ' ').trim();
        }

        // --- Tab Switching Logic ---
        function showTab(tabId) {
            // Deactivate all tab buttons and hide all content sections
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));

            // Activate the selected tab button and show its content
            if (tabId === 'listening') {
                listeningTabBtn.classList.add('active');
                listeningContent.classList.add('active');
            }
            // Speaking tab logic removed
        }

        listeningTabBtn.addEventListener('click', () => showTab('listening'));

        // --- Listening Practice Functions ---

        const playConversationBtn = document.getElementById('playConversationBtn');
        const pauseConversationBtn = document.getElementById('pauseConversationBtn');
        const stopConversationBtn = document.getElementById('stopConversationBtn'); // New stop button
        const nextScenarioBtn = document.getElementById('nextScenarioBtn');
        const conversationDisplay = document.getElementById('conversationDisplay');
        const scenarioQuestionEl = document.getElementById('scenarioQuestion');
        const optionsContainer = document.getElementById('optionsContainer');
        const checkAnswerBtn = document.getElementById('checkAnswerBtn');
        const showTranscriptBtn = document.getElementById('showTranscriptBtn');
        const quizFeedback = document.getElementById('quizFeedback');
        const quizTranscriptDisplay = document.getElementById('quizTranscriptDisplay');
        const usAccentBtn = document.getElementById('usAccentBtn');
        const ukAccentBtn = document.getElementById('ukAccentBtn');
        const scenarioNumberDisplay = document.getElementById('scenarioNumberDisplay'); // New element for scenario number

        /**
         * Selects the best available voice for a given language tag and preference.
         * Prioritizes Google voices, then Microsoft, then generic.
         * @param {string} langTag - The language tag (e.g., 'en-US', 'en-GB').
         * @returns {SpeechSynthesisVoice|null} The selected voice or null if none found.
         */
        function selectBestVoice(langTag) {
            const voices = synth.getVoices();
            const filteredVoices = voices.filter(voice => voice.lang === langTag);

            // Prioritize Google voices
            let voice = filteredVoices.find(v => v.name.includes('Google') && !v.name.includes('Female'));
            if (voice) return voice;
            voice = filteredVoices.find(v => v.name.includes('Google')); // Any Google voice

            // Then Microsoft voices
            if (!voice) voice = filteredVoices.find(v => v.name.includes('Microsoft') && !v.name.includes('Female'));
            if (!voice) voice = filteredVoices.find(v => v.name.includes('Microsoft')); // Any Microsoft voice

            // Fallback to any voice for the language
            if (!voice) voice = filteredVoices[0];

            return voice || null;
        }

        /**
         * Loads available voices and assigns them to speakerVoiceMap.
         */
        function loadVoices() {
            // If voices haven't loaded yet, retry after a short delay
            if (synth.getVoices().length === 0) {
                setTimeout(loadVoices, 100);
                return;
            }

            let voice1 = selectBestVoice(currentAccent);
            let voice2 = selectBestVoice(currentAccent);

            // Ensure voice2 is different from voice1 if possible
            const allVoicesForAccent = synth.getVoices().filter(v => v.lang === currentAccent);
            if (voice1 && voice2 && voice1.name === voice2.name && allVoicesForAccent.length > 1) {
                voice2 = allVoicesForAccent.find(v => v.name !== voice1.name) || voice1;
            } else if (!voice1 && allVoicesForAccent.length > 0) { // Fallback if selectBestVoice failed
                voice1 = allVoicesForAccent[0];
                voice2 = allVoicesForAccent.length > 1 ? allVoicesForAccent[1] : allVoicesForAccent[0];
            } else if (!voice1 && !voice2) { // Absolute fallback to any English voices
                const englishVoices = synth.getVoices().filter(v => v.lang.startsWith('en-'));
                if (englishVoices.length >= 2) {
                    voice1 = englishVoices[0];
                    voice2 = englishVoices[1];
                } else if (englishVoices.length === 1) {
                    voice1 = englishVoices[0];
                    voice2 = englishVoices[0];
                } else {
                    console.warn('No English voices found. Speech synthesis may not work.');
                }
            }

            speaker1Voice = voice1;
            speaker2Voice = voice2;

            // console.log("Final Speaker 1 Voice:", speaker1Voice ? speaker1Voice.name : 'N/A');
            // console.log("Final Speaker 2 Voice:", speaker2Voice ? speaker2Voice.name : 'N/A');
        }

        // Ensure voices are loaded when they change or initially
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = loadVoices;
        }
        loadVoices(); // Call initially in case voices are already loaded

        /**
         * Speaks the given text using SpeechSynthesisUtterance and returns a Promise.
         * @param {string} text - The text to speak.
         * @param {SpeechSynthesisVoice} voice - The voice to use.
         * @returns {Promise<void>} A promise that resolves when speech ends or rejects on error.
         */
        function speakText(text, voice) {
            return new Promise((resolve, reject) => {
                currentUtterance = new SpeechSynthesisUtterance(text);
                currentUtterance.lang = currentAccent; // Use selected accent for language
                currentUtterance.voice = voice;
                currentUtterance.onend = () => {
                    resolve();
                };
                currentUtterance.onerror = (event) => {
                    // If the error is 'interrupted' and conversation was explicitly stopped, resolve without error.
                    if (event.error === 'interrupted' && !isConversationPlaying) {
                        resolve();
                    } else {
                        console.error('SpeechSynthesisUtterance.onerror', event.error || event); // Log event.error if available
                        showMessageBox('語音合成失敗。您的瀏覽器可能不支援或有問題。', 'error');
                        reject(event); // Reject the promise on other errors
                    }
                };
                try {
                    synth.speak(currentUtterance);
                } catch (e) {
                    console.error('Error calling synth.speak:', e);
                    showMessageBox('語音合成啟動失敗。', 'error');
                    reject(e); // Reject if speak itself throws an error
                }
            });
        }

        /**
         * Displays the current scenario's conversation, question, and options.
         */
        function displayCurrentScenario() {
            const scenario = listeningScenarios[currentScenarioIndex];
            conversationDisplay.innerHTML = '<p class="text-gray-500 italic">點擊「播放對話」開始。</p>'; // Clear and reset
            scenarioQuestionEl.textContent = `問題：${scenario.question}`;
            scenarioQuestionEl.classList.add('hidden'); // Hide until conversation is played

            optionsContainer.innerHTML = ''; // Clear previous options
            scenario.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-button btn-secondary';
                button.textContent = option;
                button.dataset.index = index;
                button.addEventListener('click', () => selectOption(index));
                optionsContainer.appendChild(button);
            });

            checkAnswerBtn.disabled = true;
            showTranscriptBtn.disabled = true;
            quizFeedback.textContent = '';
            quizTranscriptDisplay.classList.add('hidden');
            selectedOptionIndex = -1; // Reset selected option

            // Update scenario number display
            scenarioNumberDisplay.textContent = `(情境 #${currentScenarioIndex + 1} / ${listeningScenarios.length})`;

            // Reset speaker map for new scenario
            speakerMap = {};
        }

        /**
         * Plays the conversation line by line.
         */
        async function playConversation() {
            const scenario = listeningScenarios[currentScenarioIndex];
            const conversationLines = scenario.conversation;
            conversationDisplay.innerHTML = ''; // Clear initial message
            synth.cancel(); // Always cancel previous speech before starting new
            
            playConversationBtn.disabled = true; // Disable play button during playback
            nextScenarioBtn.disabled = true; // Disable next scenario during playback
            pauseConversationBtn.disabled = false; // Enable pause button
            stopConversationBtn.disabled = false; // Enable stop button
            pauseConversationBtn.textContent = '暫停 ⏸️';
            isConversationPlaying = true;
            isConversationPaused = false;

            let speakerCounter = 0;
            for (let i = 0; i < conversationLines.length; i++) {
                // If stopped by user, break the loop
                if (!isConversationPlaying) {
                    break;
                }

                // Handle pause state: wait until resumed
                while (isConversationPaused && isConversationPlaying) {
                    await new Promise(resolve => setTimeout(resolve, 100)); // Poll every 100ms
                }

                // Check again if stopped after pause
                if (!isConversationPlaying) {
                    break;
                }

                const line = conversationLines[i];
                const speakerMatch = line.match(/^([^:]+):/);
                let speakerName = 'Unknown';
                let actualSpeech = line;

                if (speakerMatch) {
                    speakerName = speakerMatch[1].trim();
                    actualSpeech = line.substring(speakerMatch[0].length).trim();
                }

                if (!(speakerName in speakerMap)) {
                    speakerMap[speakerName] = speakerCounter % 2; // Assign to speaker 0 or 1
                    speakerCounter++;
                }

                const speakerIdx = speakerMap[speakerName];
                const speakerColorClass = speakerColors[speakerIdx % speakerColors.length]; // Use modular arithmetic for color
                const voiceToUse = (speakerIdx === 0) ? speaker1Voice : speaker2Voice;

                const p = document.createElement('p');
                p.className = `conversation-line text-gray-800 ${speakerColorClass}`;
                p.textContent = line;
                conversationDisplay.appendChild(p);
                conversationDisplay.scrollTop = conversationDisplay.scrollHeight; // Scroll to bottom

                try {
                    await speakText(actualSpeech, voiceToUse);
                } catch (error) {
                    console.error("Error speaking line:", error);
                    // Continue to next line even if one fails
                }

                // Add a small delay between lines for better pacing, unless paused or stopped
                if (isConversationPlaying && !isConversationPaused) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }

            // After conversation (or if stopped), reset controls
            playConversationBtn.disabled = false; // Re-enable play button
            nextScenarioBtn.disabled = false; // Re-enable next scenario button
            pauseConversationBtn.disabled = true; // Disable pause after conversation finishes
            stopConversationBtn.disabled = true; // Disable stop after conversation finishes
            pauseConversationBtn.textContent = '暫停 ⏸️';
            isConversationPlaying = false;
            isConversationPaused = false;

            synth.cancel(); // Ensure all speech is stopped at the end

            showMessageBox('對話播放完畢。請選擇答案。', 'info');
            scenarioQuestionEl.classList.remove('hidden');
            optionsContainer.querySelectorAll('.option-button').forEach(btn => btn.disabled = false);
        }

        /**
         * Handles option selection for the quiz.
         * @param {number} index - The index of the selected option.
         */
        function selectOption(index) {
            selectedOptionIndex = index;
            optionsContainer.querySelectorAll('.option-button').forEach((btn, idx) => {
                btn.classList.remove('selected');
                if (idx === index) {
                    btn.classList.add('selected');
                }
            });
            checkAnswerBtn.disabled = false; // Enable check answer button
        }

        playConversationBtn.addEventListener('click', playConversation);

        pauseConversationBtn.addEventListener('click', () => {
            if (synth.speaking && !isConversationPaused) {
                synth.pause();
                isConversationPaused = true;
                pauseConversationBtn.textContent = '繼續播放 ▶️';
                showMessageBox('對話已暫停。', 'info');
            } else if (synth.paused && isConversationPaused) {
                synth.resume();
                isConversationPaused = false;
                pauseConversationBtn.textContent = '暫停 ⏸️';
                showMessageBox('對話已恢復。', 'info');
            }
        });

        stopConversationBtn.addEventListener('click', () => {
            if (synth.speaking || synth.paused) {
                synth.cancel(); // Stop any ongoing speech
            }
            isConversationPlaying = false;
            isConversationPaused = false;
            playConversationBtn.disabled = false;
            nextScenarioBtn.disabled = false;
            pauseConversationBtn.disabled = true;
            stopConversationBtn.disabled = true;
            pauseConversationBtn.textContent = '暫停 ⏸️';
            showMessageBox('對話已停止。', 'info');
            // Re-display scenario to clear conversation text and reset state
            displayCurrentScenario();
        });


        nextScenarioBtn.addEventListener('click', () => {
            if (synth.speaking || synth.paused) {
                synth.cancel(); // Stop any ongoing speech
                isConversationPlaying = false;
                isConversationPaused = false;
                pauseConversationBtn.disabled = true;
                stopConversationBtn.disabled = true;
                pauseConversationBtn.textContent = '暫停 ⏸️';
            }
            
            // Randomly choose a new scenario, ensuring it's not the current one
            let newScenarioIndex;
            do {
                newScenarioIndex = Math.floor(Math.random() * listeningScenarios.length);
            } while (newScenarioIndex === currentScenarioIndex);
            
            currentScenarioIndex = newScenarioIndex;
            displayCurrentScenario();
            showMessageBox(`載入下一個情境：情境 #${currentScenarioIndex + 1}。`, 'info');
        });

        checkAnswerBtn.addEventListener('click', () => {
            if (selectedOptionIndex === -1) {
                showMessageBox('請先選擇一個答案。', 'warning');
                return;
            }

            const scenario = listeningScenarios[currentScenarioIndex];
            if (selectedOptionIndex === scenario.correctAnswerIndex) {
                quizFeedback.textContent = '答對了！太棒了！🎉';
                quizFeedback.className = 'text-lg font-semibold mt-4 text-green-600';
                showMessageBox('恭喜！答案正確！', 'success');
            } else {
                const correctAnswerText = scenario.options[scenario.correctAnswerIndex];
                quizFeedback.textContent = `答錯了。正確答案是：「${correctAnswerText}」。請準備好後前往下一個情境。😊`;
                quizFeedback.className = 'text-lg font-semibold mt-4 text-red-600';
                showMessageBox('答案不正確。', 'error');
            }
            checkAnswerBtn.disabled = true; // Disable check answer after one attempt
            showTranscriptBtn.disabled = false; // Enable show transcript
            optionsContainer.querySelectorAll('.option-button').forEach(btn => btn.disabled = true); // Disable options after checking
        });

        showTranscriptBtn.addEventListener('click', () => {
            const scenario = listeningScenarios[currentScenarioIndex];
            quizTranscriptDisplay.textContent = `中文原文：\n${scenario.chineseTranslation}`;
            quizTranscriptDisplay.classList.remove('hidden');
        });

        usAccentBtn.addEventListener('click', () => {
            currentAccent = 'en-US';
            usAccentBtn.classList.add('btn-primary');
            usAccentBtn.classList.remove('btn-secondary');
            ukAccentBtn.classList.add('btn-secondary');
            ukAccentBtn.classList.remove('btn-primary');
            loadVoices(); // Reload voices based on new accent preference
            showMessageBox('已切換到美式口音 🇺🇸。', 'info');
        });

        ukAccentBtn.addEventListener('click', () => {
            currentAccent = 'en-GB';
            ukAccentBtn.classList.add('btn-primary');
            ukAccentBtn.classList.remove('btn-secondary');
            usAccentBtn.classList.add('btn-secondary');
            usAccentBtn.classList.remove('btn-primary');
            loadVoices(); // Reload voices based on new accent preference
            showMessageBox('已切換到英式口音 🇬🇧。', 'info');
        });

        // --- Initial Load ---
        window.onload = () => {
            // Display the first listening scenario
            displayCurrentScenario();
            showMessageBox('歡迎使用您的英語學習應用程式！', 'info');
        };

    </script>
</body>
</html>
